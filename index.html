<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PodPultem – Katalog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data:; img-src 'self' https: data:; script-src 'self' https://cdn.tailwindcss.com 'unsafe-inline'; style-src 'self' 'unsafe-inline'">
</head>
<body class="bg-neutral-950 text-neutral-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex items-end justify-between mb-6">
      <h1 class="text-3xl md:text-4xl font-black tracking-tight">PodPultem</h1>
      <input id="search" class="px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800" placeholder="Hledat…">
    </header>
    <main id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></main>
  </div>

<script>
  // Konst
  var ACCESS_TOKEN='shadow2025';
  var ALL="58913469,58914294,58961797,58938633,58991599,58914666,58914670,58914676,58914766,58915821,58915645,58915678,58937229,58930968,58959728,58961878,59011605,59011650,59011725,59020639,59036714,59036804";
  var FX={ CNY_TO_CZK:3.2, MARKUP:1.6, SHIPPING_CZK:0 };
  function priceFromCNY(c){ return Math.round((Number(c||0)*FX.CNY_TO_CZK*FX.MARKUP+FX.SHIPPING_CZK)/10)*10; }
  function cur(n){ return new Intl.NumberFormat('cs-CZ',{style:'currency',currency:'CZK'}).format(n); }
  function norm(p){
    var img = (Array.isArray(p.images)&&p.images[0]) ? p.images[0] : (p.image||"");
    var cny = p.priceCNY!=null ? Number(p.priceCNY) : null;
    var czk = Number.isFinite(p.priceCZK) ? p.priceCZK : (cny!=null ? priceFromCNY(cny) : null);
    return { id:p.id||p._id||p.url||Math.random(), name:p.name||p.title||"", brand:p.brand||"", image:img, url:p.url||p.link||"", priceCZK:czk };
  }

  var state={items:[], q:""};
  var grid=document.getElementById('grid');
  var search=document.getElementById('search');

  function render(){
    var q=state.q.toLowerCase();
    var items=state.items.filter(function(p){
      return (p.name||"").toLowerCase().indexOf(q)>-1 || (p.brand||"").toLowerCase().indexOf(q)>-1;
    });
    var html="";
    items.forEach(function(p){
      html+= '<article class="rounded-2xl overflow-hidden bg-neutral-900 border border-neutral-800 shadow">'
           +   '<div class="aspect-[4/3]"><img class="w-full h-full object-cover" loading="lazy" src="'+(p.image||'')+'" alt="'+(p.name||'')+'"></div>'
           +   '<div class="p-4">'
           +     '<div class="text-sm text-neutral-400">'+(p.brand||'')+'</div>'
           +     '<h3 class="text-lg font-semibold">'+(p.name||'')+'</h3>'
           +     '<div class="pt-1 font-bold">'+(Number.isFinite(p.priceCZK)?cur(p.priceCZK):'Na dotaz')+'</div>'
           +   '</div>'
           + '</article>';
    });
    grid.innerHTML = html || '<div class="text-neutral-400">Žádné produkty.</div>';
  }

  // Jedno volání na API
  fetch('/api/raindrop?collections='+encodeURIComponent(ALL)+'&token='+ACCESS_TOKEN)
    .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
    .then(function(d){
      var arr = Array.isArray(d.products) ? d.products : (Array.isArray(d.items)?d.items:[]);
      state.items = arr.map(norm);
      render();
    })
    .catch(function(e){
      console.error(e);
      grid.innerHTML = '<div class="text-rose-400">Chyba načítání API.</div>';
    });

  search.oninput=function(e){ state.q=e.target.value; render(); };
</script>
</body>
</html>
